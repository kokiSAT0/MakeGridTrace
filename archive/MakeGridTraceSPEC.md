# スリザーリンク 盤面生成仕様書 v1.0

作成日: 2025‑07‑02
作成者: ChatGPT

---

## 1. 目的

本ドキュメントは **Python** でスリザーリンクのパズル盤面（問題 JSON）を自動生成するプログラムを開発するための要件を整理する。エンジニアはスリザーリンクの遊び方や定石を知らない前提で、ゲームとして成立する“良質な問題”を安定して出力できるよう、**ハード制約**（絶対遵守）と **ソフト制約**（望ましい品質）の両面を明示する。

> **注**: JSON 形式は別紙 **slitherlink_map_spec_v1.md** に従うこと。

---

## 2. 用語

| 用語        | 意味                                                             |
| ----------- | ---------------------------------------------------------------- |
| セル (cell) | マス目。ヒント数字 0–3 または空白(`null`)を持つ                  |
| 点 (dot)    | 格子点 (r, c) = (0‥rows, 0‥cols)                                 |
| 辺 (edge)   | 点と点を結ぶ線分（水平 or 垂直）。ユーザは辺を引いてループを作る |
| ループ      | 分岐・交差なしで閉じる 1 本の連続した線の集合                    |
| 解の一意性  | プレイヤが論理的に辿り着ける正解が 1 通りのみであること          |

---

## 3. 入出力インターフェース

### 3.1 主要関数（例）

```python
Puzzle = dict  # 仕様書に準拠した JSON を Python dict で表現

def generate_puzzle(rows: int, cols: int, difficulty: str = "normal", *, seed: int | None = None) -> Puzzle:
    """盤面を生成して返す。
    rows, cols: 4–30 程度を想定（可変）。
    difficulty: "easy" | "normal" | "hard" | "expert"。
    seed: 再現性確保用（Optional）。"""

```

### 3.2 成果物

- 返値は **dict** —> JSON ダンプして保存（ファイル名は `map_gridtrace.json` に固定）
- `stdout` へログレベル INFO 以上を出力し、生成状況をレポート（サイズ、難易度、検証統計など）

---

## 4. ハード制約

| #   | 制約                                                                  | 検証方法                                                                        |
| --- | --------------------------------------------------------------------- | ------------------------------------------------------------------------------- |
| H‑1 | **単一閉ループ**を形成する                                            | 生成後、オイラー路ではなく閉サイクルであることを DFS/BFS で確認                 |
| H‑2 | **分岐・交差・複数ループなし**                                        | 各点の次数 ∈ {0,2} をチェックし、全辺が一連のサイクルに属するか確認             |
| H‑3 | **ヒント整合** — 各数字セルの周囲 4 辺のうち線分数 = 数字             | 盤面走査で 4 方向を数える                                                       |
| H‑4 | **解が一意**                                                          | 既製ソルバー（バックトラック＋早期枝刈り）で解数をカウントし 1 であることを保証 |
| H‑5 | **JSON 構造厳格準拠**                                                 | スキーマバリデータ or `jsonschema` による検証                                   |
| H‑6 | **最小ヒント数** — 空白セルのみの出力は禁止（難易度に応じて下限設定） | ヒント数 ≧ MIN_HINTS\[difficulty]                                               |
| H‑7 | **ループ長下限** — 盤面外周だけのミニループ等は NG                    | ループの辺数 ≥ 2 × (rows + cols)                                                |

---

## 5. ソフト制約（品質ガイドライン）

| カテゴリ   | 指針                                                                                                                    | 例示                                         |
| ---------- | ----------------------------------------------------------------------------------------------------------------------- | -------------------------------------------- |
| 難易度     | イージーでは単純な推論（ゼロ/スリー即決など）で解ける問題を多めに。ハード以上は**行き詰まりにくいが深い論理**を要求する | イージー: ヒント密度 30–40% / ハード: 15–25% |
| ヒント分布 | 盤面全体にバランス良く配置し、孤立した“死角”を減らす                                                                    | 連続 3×3 ブロックすべて `null` を避ける      |
| 美観       | 180° 回転対称や線対称にするオプションを提供                                                                             | `symmetry="rotational"` キーを付与           |
| ループ形状 | 外周をなぞるだけの単調なパスは避け、内側にも折り返しを含む                                                              | 線の曲がり角率 ≥ 20%                         |
| 多様性     | 同サイズ連続生成時、ヒントパターンとループ形状の類似度を抑制                                                            | 直近 N 件との Jaccard 距離 ≥ 0.3             |
| メタデータ | `createdBy`, `createdAt`, `difficulty` を必ず付与                                                                       | `createdBy="auto‑gen‑v1"`                    |

---

## 6. 難易度判定アルゴリズム（参考実装レベル）

1. **ロジックソルバー**を実装し、以下の指標を記録

   - 単純ルール適用で確定した辺数 / 総辺数
   - バックトラック深さ
   - 解析ステップ数

2. しきい値例：

   | 指標               | easy | normal | hard     | expert |
   | ------------------ | ---- | ------ | -------- | ------ |
   | 解析ステップ       | < 1k | 1k–10k | 10k–100k | >100k  |
   | バックトラック深さ | 0–2  | 3–10   | 11–30    | >30    |

3. 生成後、この分類にマッピングし `difficulty` フィールドに反映

---

## 7. 生成パイプライン概要

```mermaid
flowchart TD
    A[初期化: rows, cols の決定] --> B[ランダムループ生成]
    B --> C[ヒント導出 (0–3)]
    C --> D[ヒント削減 & 整合性維持]
    D --> E[解の一意性チェック]
    E -- NG --> C
    E -- OK --> F[難易度評価]
    F --> G[JSON 組み立て]
    G --> H[スキーマ & QA 検証]
    H -- Pass --> I[保存 / 返却]
```

### 7.1 詳細フロー

1. **ループ生成**

   - **アルゴリズム候補**: 埋め込み DFS、ランダムウォーク + 自己衝突回避、あるいは長方形分割再結合法
   - 目標ループ長 = `0.75 × 2 × (rows + cols)` 以上

2. **ヒント導出**

   - 各セル周囲 4 辺の線数を計算し 0–3 を設定。

3. **ヒント削減**

   - 全ヒント配置後、ランダム順に `null` 化しながら H‑4 (一意性) を満たす範囲で削減。

4. **整合性 & QA**

   - H‑1〜H‑7 を満たすまでループ。

---

## 8. エラーハンドリング & 再試行

| ケース        | 対策                                                    |
| ------------- | ------------------------------------------------------- |
| 解が多重 (≥2) | ヒント数を 1 つ戻す or ループ生成をやり直す             |
| ループ長不足  | 生成アルゴリズム再実行（シード変更）                    |
| 制限時間超過  | 現ステップ破棄、全行程をリトライ（最大 RETRY_LIMIT 回） |

---

## 9. ログ & テレメトリ

- `generate_puzzle()` では生成に関する JSON シリアライズ可能な統計を返すオプションを用意
  例: `{"loop_length": 56, "hint_count": 18, "solver_steps": 842}`
- CI で 1000 問連続生成し、失敗率 < 0.5% を目標

---

## 10. テスト指針

1. **ユースケース単体テスト** – 各行サイズでハード制約を満たすか自動確認
2. **回帰テスト** – 既知の生成失敗シードを fixture 化し再チェック
3. **パフォーマンスベンチ** – 10×10 normal を 100 問生成し平均 0.5 s 以内

---

## 11. 今後の拡張余地

- ヒント数字 4 の採用（非標準ルール）
- 閉ループ複数本モード（不等辺クローズトライアル）
- WebAssembly 化によるブラウザ内生成

---

## 12. 参考リンク

- スリザーリンク マップデータ仕様書 v1.0 (別紙)
- Nikoli 本家ルール解説
- Academic paper: _Generating Unambiguous Slitherlink Puzzles via Constraint Programming_, 2023

---

_本仕様に関する質問は Slack #slitherlink-dev まで_
