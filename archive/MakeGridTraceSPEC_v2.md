# スリザーリンク 盤面生成仕様書 **v2.0‑draft**

作成日: 2025‑07‑02  
改訂者: ChatGPT (auto‑gen‑v2)

> **本書の位置づけ**  
> v1.0 仕様の実運用結果とユーザフィードバックを踏まえ、**盤面の娯楽性・多様性・生成安定性**を高めるための全面改訂版です。  
> 旧仕様との互換性は _基本的に保持_ しつつ、JSON スキーマにバージョニングを導入しました。  

---

## 変更概要

| 項目                         | v1.0 → v2.0 の主な差分 |
|------------------------------|------------------------|
| JSON スキーマ                | `schemaVersion` フィールドを追加し 2.x 系へ |
| 難易度判定                   | **統計ベース** → **ソルバー手筋トレース**へ刷新 |
| ハード制約                   | 2 件追加 (H‑8, H‑9)    |
| ソフト制約                   | 美観・多様性 KPI を数値化 |
| 生成 API                     | `theme`, `symmetry`, `timeout_s` など引数拡張 |
| テスト & CI                  | 生成品質ダッシュボードを定義 |
| ログ & テレメトリ            | OpenTelemetry 対応、匿名ハッシュ化シードを送出 |
| プライバシー                | 再現用シードを暗号化してメタデータに埋込 |

---

## 1. 目的

**Python** でスリザーリンクのパズル盤面を _高品質かつ大規模に_ 自動生成するための技術仕様を示す。  
v2.0 では単なる「一意解のパズル」を超え、**解いて楽しい**・**学習曲線がなめらか**・**見た目が美しい** といったプレイヤ体験に直結する指標を正式に定義する。

---

## 2. 用語 (拡張)

| 用語                  | 意味                                                     |
|-----------------------|----------------------------------------------------------|
| エッジグループ        | 同一セルを挟む 2 本の対向辺 (水平または垂直) のペア       |
| 線カーブ比率          | ループ全辺に占める「曲がり角」(90°) の割合               |
| パターンライブラリ    | 0‑corner, 3‑touch, 1‑sandwich など **誘導手筋** テンプレ |
| ソルバートレース      | ロジックソルバーが記録した「手筋適用ログ」の集合         |
| Quality Score (QS)    | 本仕様で導入する総合品質指数 (0‑100)                     |

---

## 3. 入出力インターフェース

### 3.1 主要 API

```python
Puzzle = dict  # JSON Ready

def generate_puzzle(
        rows: int,
        cols: int,
        *,
        difficulty: str = "normal",
        theme: str | None = None,
        symmetry: str | None = None,
        timeout_s: float = 10.0,
        seed: int | None = None
) -> Puzzle:
    """盤面を生成して返す。

    rows, cols  : 4–30 程度。
    difficulty  : "easy" | "normal" | "hard" | "expert"。
    theme       : "spiral" | "maze" | "islands" | None など (オプション)。
    symmetry    : None | "rotational" | "mirror‑hv"。
    timeout_s   : 世代探索のタイムアウト (秒)。
    seed        : 再現性確保用 (Optional)。
    """
```

### 3.2 出力 JSON

| フィールド                 | 型      | 説明                                       |
|---------------------------|---------|--------------------------------------------|
| `schemaVersion`           | string  | `"2.0"` 固定                               |
| `grid`                    | int[][] | ヒント数字 (0‑3) または `null`             |
| `createdAt`               | string  | ISO‑8601                                   |
| `createdBy`               | string  | 例: `"auto‑gen‑v2"`                        |
| `difficulty`              | string  | 実測難易度ラベル                           |
| `qualityScore`            | number  | 0–100                                      |
| `loopStats`               | object  | `{"length": 64, "curveRatio": 0.31}`       |
| `solverStats`             | object  | 後述                                       |
| `generationParams`        | object  | 呼び出しパラメータのエコーバック           |
| `seedHash`                | string  | SHA‑256( seed || salt ) の Base64 上位 22B |

---

## 4. ハード制約 (改訂)

| #   | 制約                                                             | 検証方法 |
|-----|------------------------------------------------------------------|----------|
| H‑1 | **単一閉ループ**を形成する                                       | DFS/BFS |
| H‑2 | **分岐・交差・複数ループなし**                                   | 点次数 ∈ {0,2} |
| H‑3 | **ヒント整合** — 各数字セルの周囲 4 辺の線分数 == 数字           | 全セル走査 |
| H‑4 | **解の一意性**                                                   | 2 系統ソルバー (論理式/制約) で cross‑check |
| H‑5 | **JSON 構造厳格準拠**                                            | `jsonschema` |
| H‑6 | **最小ヒント数** (difficulty 別)                                 | `hintCount >= MIN_HINTS[difficulty]` |
| H‑7 | **ループ長下限**                                                 | `len(edges) >= 2 × (rows + cols)` |
| H‑8 | **ゼロ隣接制御** — 数字 0 同士が辺共有する配置は禁止             | 0‑セルの水平/垂直隣接を走査 |
| H‑9 | **線カーブ比率下限** ≥ 15%                                       | `curveRatio` 計算 |

---

## 5. ソフト制約 (品質 KPI)

| 指標            | easy      | normal    | hard      | expert    |
|-----------------|-----------|-----------|-----------|-----------|
| ヒント密度      | 28–38 %   | 20–30 %   | 14–22 %   | 10–18 %   |
| Quality Score   | ≥ 60      | ≥ 70      | ≥ 80      | ≥ 88      |
| ループ折返し回数| ≥ 6       | ≥ 8       | ≥ 12      | ≥ 18      |
| ヒント分散度    | ≥ 0.78    | ≥ 0.80    | ≥ 0.82    | ≥ 0.85    |

### QS (Quality Score) 計算式

```
QS = 20·log10(curveRatio·100)  
     + 25·entropy(hintDistribution)  
     + 15·solverRuleCoverage / MAX_RC  
     + 40·(1 - similarityToLastN)
```

係数は A/B テストで調整可能。

---

## 6. 難易度判定アルゴリズム (v2)

1. **ソルバー手筋セット**  
   - `Basic Zero` / `Basic Three` / `1‑2 Chain` ... `Advanced Loop Forcing`
2. 解析ログに各手筋適用回数をタグ付け。
3. 下表しきい値で difficulty を決定する (例):

| 手筋層            | easy | normal | hard | expert |
|-------------------|------|--------|------|--------|
| 基本 (層 0–1)     | ≤ 95%| 60–95% | 40–70% | ≤40% |
| 中級 (層 2–3)     | ≤5%  | 5–30%  | 20–45% | 30–55% |
| 上級 (層 4 以上)  | 0%   | ≤10%   | 10–35% | ≥35% |

---

## 7. 生成パイプライン (刷新)

```mermaid
flowchart TD
    A[パラメータ受領] --> B[ベースループ生成<br/>(Improved DFS + Bezier bias)]
    B --> C[ヒント導出]
    C --> D[ヒント最適化<br/>(Simulated Annealing)]
    D --> E[一意性 & 制約検証]
    E -- NG --> B
    E -- OK --> F[ソルバートレース & QS]
    F --> G[難易度ラベリング]
    G --> H[JSON アセンブル]
    H --> I[スキーマ & QA]
    I --> J[返却 / 永続化]
```

**主な改良点**

- D: 旧ランダム削減 → **焼きなまし法**でスコア最大化。  
- B: ループ初期形状に **パターンライブラリ**を注入し学習用トレースを生成。  
- 全体を `timeout_s` でガード、超過時は品質低下を許容しつつ最後に低難易度でフェイルオーバー。

---

## 8. パターンライブラリ

| コード | 目的                             | ヒント例 |
|--------|----------------------------------|----------|
| P‑01   | 0‑cornerで外周スタートを促す      | 0                                          |
| P‑12   | 3‑1‑3 サンドイッチで角度強制     | 3 1 3                                      |
| P‑23   | ジグザグ廊下で長鎖推論を誘発     | 1‑null‑1 / 3‑null‑3                        |

パターンは YAML で外部定義し、A/B テストでオンオフ可能。

---

## 9. エラーハンドリング

| ケース                | 対応                                             |
|-----------------------|--------------------------------------------------|
| timeout_s 超過        | 現在のベスト (QS≥50) を返し `partial=True` 設定 |
| 解なし / 多重解        | ループ再生成。3 回失敗で `ValueError`          |
| Internal Solver Crash | フォールバックソルバーへ切替え、ログ残存        |

---

## 10. ログ & テレメトリ

- OpenTelemetry Traces (`slitherlink.gen.*`)  
- 各生成で `generation_id = ULID` を発行  
- 統計バッチを BigQuery‑compatible JSON で吐き出し

---

## 11. テスト指針 (拡張)

1. **品質ゲート** — CI で QS 分布ヒストグラムを生成し P95≥70 を要求  
2. **負荷試験** — 30×30 expert を 1,000 件生成し timeout_s=20s を守れるか

---

## 12. セキュリティ & プライバシー

- 生成シードは `seedHash` のみを公開し実シードは KMS に保管  
- crash dump は 72 時間後自動削除

---

## 13. 今後の拡張

- **数字 4** の正式採用 (フェーズ 2)  
- **ミニループ禁止 / 多ループ許可** のモード切替  
- **人間・AI 混合プレイログ** をフィードバックした強化学習生成

---

_本仕様に関する質問は Slack #slitherlink‑dev まで_

