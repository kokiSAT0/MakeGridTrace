# パズルマップ生成ロジック仕様書

作成日: 2025-07-02
作成者: ChatGPT

---

## 1. 目的

本ドキュメントは `src/generator.py` で実装されているスリザーリンク用パズルマップ生成処理をまとめたものです。プロジェクトマネージャーや専門家が現状のロジックを把握し、改善点を議論するための資料となります。

---

## 2. 入力パラメータ

`generate_puzzle` 関数に渡す主な引数は次のとおりです。

| 引数名 | 型 | 説明 |
|-------|----|------|
| `rows` | int | 盤面の行数 |
| `cols` | int | 盤面の列数 |
| `difficulty` | str | 難易度ラベル。`easy` `normal` `hard` `expert` のいずれか |
| `seed` | int \| None | 乱数シード。指定すると同じ盤面を再生成できます |
| `symmetry` | str \| None | `rotational` `vertical` `horizontal` を指定すると対称形状になります |
| `theme` | str \| None | `border` `pattern` `maze` `spiral` のいずれか。盤面形状に影響 |
| `solver_step_limit` | int | ソルバー探索ステップの上限。既定値は 500000 |
| `timeout_s` | float \| None | タイムアウト秒数。超過すると途中結果を返すことがあります |
| `return_stats` | bool | `True` を指定するとソルバー統計を返します |

これらの値は `generationParams` として JSON にそのまま保存されます。

---

## 3. 生成手順の概要

1. **ループ生成**
   - `_generate_loop_with_symmetry` 関数で解ループ(`solutionEdges`)を作成します。
   - `theme` により生成方法が変化します。
     - `border`: 外周だけを通る単純なループ。
     - `pattern`: 3x3 や 4x4 の小ループパターンを敷き詰めて結合します。
     - `maze`: 複数候補から長さと曲率のスコアが高いループを採用します。
     - `spiral`: 曲率比率が最も大きいループを選択します。
     - 指定なし: 完全ランダムで生成します。
   - `symmetry` を指定すると回転・上下・左右対称になるよう補正します。
   - 生成失敗時は再試行し、最終的に外周ループを返します。

2. **ヒント計算と削減**
   - `calculate_clues` で各セルの数字を計算します。
   - 難易度ごとに決まる `MIN_HINT_RATIO` を下回らない範囲で `_reduce_clues` がヒントをランダム削除します。
   - `count_solutions` を用いて解が一意であるか確認し、そうでなければ再試行します。

3. **ヒント最適化**
   - `_optimize_clues` でヒント配置を焼きなまし法により微調整します。
   - 曲率比率やヒント分散度などから算出する **Quality Score** を改善できる場合に変更を採用します。

4. **JSON 組み立て**
   - `_build_puzzle_dict` で以下の情報をまとめます。
     - `schemaVersion` (現在は 2.0)
     - サイズ、ヒント、正解ループ
     - 生成時の統計 (`loopStats`、`solverStats`、`qualityScore` 等)
     - 難易度評価値や対称性、テーマ
   - `seedHash` としてシード値の SHA-256 ハッシュも保存します。

---

## 4. ループ生成の詳細

ループ生成は `_create_loop` 関数が担当します。以下のルールを持ちます。

- まず空の辺情報を作り、深さ優先探索によりランダムな閉ループを探します。
- `maze` や `spiral` テーマでは候補を複数作り、長さや曲率の良いものを選びます。
- 対称性を指定した場合は `_apply_rotational_symmetry` などで辺を補正します。
- すべての頂点は次数 0 または 2 になるよう `_validate_edges` で確認します。
- 失敗が続いたときは外周ループのみの盤面を返します。

---

## 5. Quality Score の概要

ヒント密度、曲率比率、ヒントの散らばり具合、0 の隣接数など複数の要素から 0～100 のスコアを計算します。値が高いほどバランスの良い良問とみなします。現行実装では主に以下を加味します。

- ループの曲率比率 (`curveRatio`)
- ヒントのエントロピー（密度のばらつき）
- 盤面全体へのヒント分散度
- 行・列ごとのヒント数バランス
- ソルバーが要したステップ数

---

## 6. 生成に失敗した場合

タイムアウト (`timeout_s`) を超えた場合や再試行上限に達した場合、最後に得られた盤面を `partial: true` として返すことがあります。このとき品質や一意性は保証されません。

---

## 7. 今後の検討ポイント

- Quality Score 計算式の妥当性と重み付け
- `theme` や `symmetry` のバリエーション追加
- 生成速度と成功率の向上 (並列実行の最適化)
- ユーザー向け難易度ラベルの調整

以上が現時点のマップ生成ロジックのまとめです。ご確認のうえ、改善案を検討ください。

